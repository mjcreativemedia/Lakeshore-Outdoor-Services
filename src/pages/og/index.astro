---
import { BUSINESS } from "../../data/business";
import { formatPhoneForDisplay } from "../../utils/phone";
import {
  OG_IMAGE_HEIGHT,
  OG_IMAGE_WIDTH,
  createOgSvg,
  rasterizeSvgToPng,
} from "../../utils/og-image";

export const prerender = false;

const searchParams = Astro.url.searchParams;

const title = searchParams.get("title")?.trim() || `${BUSINESS.name}`;
const subtitle = searchParams.get("subtitle")?.trim() || "Snow & Ice Management for Chicago & the North Shore";
const tagline = searchParams.get("tagline")?.trim() || "Plowing, salting, and sidewalk crews on call all winter";
const contact = searchParams.get("contact")?.trim() || formatPhoneForDisplay(BUSINESS.phone);

const scaleParam = Number(searchParams.get("scale"));
const backgroundParam = searchParams.get("background")?.trim();

const svg = createOgSvg({
  title,
  subtitle,
  tagline,
  contact,
  brand: BUSINESS.name,
});

const png = await rasterizeSvgToPng(svg, {
  scale: Number.isFinite(scaleParam) ? scaleParam : undefined,
  background: backgroundParam?.length ? backgroundParam : undefined,
  width: OG_IMAGE_WIDTH,
  height: OG_IMAGE_HEIGHT,
});

return new Response(png, {
  headers: {
    "Content-Type": "image/png",
    "Content-Length": String(png.byteLength),
    "Cache-Control": "public, max-age=86400, immutable",
  },
});
---
